@model List<TblProduct>

<input type="hidden" id="hfSaleId" value="@ViewBag.SaleId" />

<div class="mb-3">
    <label for="txtProductName" class="form-label">Product Name</label>
    <select class="form-control" id="txtProductName">
        <option value="">Select Product</option>
        @foreach (var product in Model)
        {
            <option value="@product.ProductId" data-price="@product.Price">
                @product.ProductName - ฿@product.Price
            </option>
        }
    </select>
</div>

<div class="mb-3">
    <label for="txtQuantity" class="form-label">Quantity</label>
    <input type="number" class="form-control" id="txtQuantity">
</div>
<div class="mb-3">
    <label for="txtTotal" class="form-label">Total</label>
    <input type="text" class="form-control" id="txtTotal" readonly>
</div>
<div class="mb-3">
    <label for="txtDate" class="form-label">Date</label>
    <input type="date" class="form-control" id="txtDate">
</div>
<a href="/Sale" class="btn btn-secondary">Cancel</a>
<button type="button" class="btn btn-primary" id="btnUpdate">Update</button>

@section scripts
{
    <script>
        $(document).ready(function () {
            loadData();

            $('#txtProductName, #txtQuantity').on('change input', function() {
                calculateTotal();
            });
        });
        
        function loadData() {
            const saleId = $('#hfSaleId').val();
            $.ajax({
                url: `/Sale/Edit/${saleId}`,
                method: "GET",
                success: (response) => {
                    $('#txtProductName').val(response.productId);
                    $('#txtQuantity').val(response.quantity);

                    if (response.saleDate) {
                        const saleDate = new Date(response.saleDate);
                        const formattedDate = saleDate.toISOString().split('T')[0];
                        $('#txtDate').val(formattedDate);
                    }

                    calculateTotal();
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                }
            });
        }

        function calculateTotal() {
            const selectedOption = $('#txtProductName option:selected');
            const price = parseFloat(selectedOption.data('price')) || 0;
            const quantity = parseInt($('#txtQuantity').val()) || 0;
            const total = price * quantity;

            $('#txtTotal').val('฿' + total.toFixed(2));
        }
        
        $('#btnUpdate').click(function () {
            const saleId = $('#hfSaleId').val();
            const saleData = {
                productId: $('#txtProductName').val(),
                quantity: $('#txtQuantity').val(),
                saleDate: $('#txtDate').val(),
            };
            
            $.ajax({
                url: `/Sale/Update/${saleId}`,
                method: "POST",
                data: saleData,
                success: (response) => {
                    if (response.isSuccess) {
                        window.location.href = "/Sale";
                    }
                },
                error: (xhr) => {
                    console.error(xhr.responseText);
                }
            })
        })
    </script>
}